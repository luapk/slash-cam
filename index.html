<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNIKT â€” Wolverine AR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LANDING SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #landing {
            position: fixed; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: linear-gradient(165deg, #0a0a0a 0%, #1a1008 40%, #0a0a0a 100%);
            z-index: 200;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        #landing.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .landing-glow {
            position: absolute;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,170,0,0.08) 0%, transparent 70%);
            top: 50%; left: 50%;
            transform: translate(-50%, -60%);
            animation: glow-pulse 3s ease-in-out infinite;
        }
        @keyframes glow-pulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -60%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -60%) scale(1.2); }
        }

        .landing-claw-icon {
            width: 80px; height: 80px;
            margin-bottom: 24px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .landing-claw-icon svg { width: 100%; height: 100%; }
        
        .landing-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 56px;
            letter-spacing: 12px;
            color: #fff;
            text-shadow: 0 0 40px rgba(255,170,0,0.3);
            position: relative; z-index: 1;
            margin-bottom: 8px;
        }
        .landing-subtitle {
            font-size: 11px;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: rgba(255,170,0,0.6);
            margin-bottom: 48px;
            position: relative; z-index: 1;
        }

        #start-ar-btn {
            position: relative; z-index: 1;
            background: transparent;
            border: 1px solid rgba(255,170,0,0.4);
            color: #ffaa00;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 6px;
            padding: 16px 48px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #start-ar-btn:hover, #start-ar-btn:active {
            background: rgba(255,170,0,0.1);
            border-color: rgba(255,170,0,0.8);
            box-shadow: 0 0 30px rgba(255,170,0,0.15);
        }
        #start-ar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .landing-compat {
            position: absolute;
            bottom: 40px;
            font-size: 10px;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.25);
            text-align: center;
            line-height: 1.6;
            padding: 0 32px;
        }
        .landing-compat a {
            color: rgba(255,170,0,0.4);
            text-decoration: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AR DOM OVERLAY (visible during session)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #ar-overlay {
            position: fixed; inset: 0;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        #ar-overlay.active { display: block; }

        /* Top HUD */
        .ar-hud-top {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 52px 20px 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .slash-counter {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            letter-spacing: 3px;
            color: rgba(255,255,255,0.7);
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 14px;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 4px;
            pointer-events: auto;
        }
        .slash-counter span {
            color: #ffaa00;
            font-size: 22px;
            vertical-align: middle;
        }

        .ar-btn-group {
            display: flex; gap: 8px;
        }
        .ar-icon-btn {
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 4px;
            color: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s ease;
        }
        .ar-icon-btn:active {
            background: rgba(255,170,0,0.2);
            border-color: rgba(255,170,0,0.4);
        }
        .ar-icon-btn svg {
            width: 20px; height: 20px;
        }

        /* Bottom area */
        .ar-hud-bottom {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 16px 20px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .ar-hint {
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            text-align: center;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            transition: opacity 0.4s ease;
        }
        .ar-hint.hidden { opacity: 0; }

        .ar-action-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
        }

        .ar-action-btn {
            width: 44px; height: 44px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 50%;
            color: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ar-action-btn:active {
            background: rgba(255,170,0,0.2);
            border-color: rgba(255,170,0,0.4);
        }
        .ar-action-btn svg { width: 20px; height: 20px; }

        .slash-btn {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: rgba(255,170,0,0.15);
            border: 2px solid rgba(255,170,0,0.6);
            color: #ffaa00;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.15s ease;
            position: relative;
        }
        .slash-btn::after {
            content: '';
            position: absolute; inset: -6px;
            border-radius: 50%;
            border: 1px solid rgba(255,170,0,0.15);
        }
        .slash-btn:active {
            transform: scale(0.92);
            background: rgba(255,170,0,0.3);
        }
        .slash-btn svg { width: 32px; height: 32px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SHARE TRAY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #share-tray {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(10,10,10,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.08);
            padding: 24px 20px 40px;
            z-index: 300;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            pointer-events: auto;
        }
        #share-tray.open { transform: translateY(0); }

        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .share-header h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 3px;
            color: #fff;
        }
        .share-close {
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 50%;
            color: rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .share-close svg { width: 16px; height: 16px; }

        .share-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 20px;
            display: none;
        }

        .share-options {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        .share-option {
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
            cursor: pointer;
            pointer-events: auto;
        }
        .share-option-icon {
            width: 56px; height: 56px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.15s ease;
        }
        .share-option-icon:active { transform: scale(0.92); }
        .share-option-icon svg { width: 24px; height: 24px; }
        .share-option-label {
            font-size: 10px;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
        }

        .share-native { background: linear-gradient(135deg, #ffaa00, #ff6600); }
        .share-native svg { color: #000; }
        .share-download { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); }
        .share-download svg { color: #fff; }
        .share-copy { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); }
        .share-copy svg { color: #fff; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SHARE OVERLAY BACKGROUND
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #share-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 250;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: auto;
        }
        #share-backdrop.open { opacity: 1; visibility: visible; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SLASH FLASH EFFECT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .slash-flash {
            position: fixed; inset: 0;
            background: radial-gradient(ellipse at center, rgba(255,170,0,0.15) 0%, transparent 70%);
            z-index: 90;
            pointer-events: none;
            opacity: 0;
        }
        .slash-flash.active {
            animation: flash-burst 0.35s ease-out forwards;
        }
        @keyframes flash-burst {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST NOTIFICATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast {
            position: fixed;
            top: 80px; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,170,0,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.8);
            z-index: 400;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           UNSUPPORTED MESSAGE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .unsupported-msg {
            position: relative; z-index: 1;
            text-align: center;
            padding: 20px 32px;
            max-width: 320px;
        }
        .unsupported-msg p {
            font-size: 13px;
            line-height: 1.7;
            color: rgba(255,255,255,0.5);
            margin-bottom: 16px;
        }
        .unsupported-msg .error-detail {
            font-size: 11px;
            color: rgba(255,100,100,0.6);
            font-family: monospace;
        }
    </style>
</head>
<body>

    <!-- â•â•â• LANDING SCREEN â•â•â• -->
    <div id="landing">
        <div class="landing-glow"></div>
        <div class="landing-claw-icon">
            <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 68 L24 12 L28 68" stroke="#ffaa00" stroke-width="2" fill="rgba(255,170,0,0.1)" stroke-linecap="round"/>
                <path d="M36 68 L40 8 L44 68" stroke="#ffaa00" stroke-width="2" fill="rgba(255,170,0,0.1)" stroke-linecap="round"/>
                <path d="M52 68 L56 12 L60 68" stroke="#ffaa00" stroke-width="2" fill="rgba(255,170,0,0.1)" stroke-linecap="round"/>
            </svg>
        </div>
        <div class="landing-title">SNIKT</div>
        <div class="landing-subtitle">Wolverine AR Experience</div>
        <button id="start-ar-btn" disabled>CHECKING DEVICEâ€¦</button>
        <div id="unsupported-area"></div>
        <div class="landing-compat">
            WebXR Augmented Reality<br>
            Chrome on Android required &middot; <a href="https://immersive-web.github.io/webxr-samples/" target="_blank">Learn more</a>
        </div>
    </div>

    <!-- â•â•â• AR SESSION OVERLAY â•â•â• -->
    <div id="ar-overlay">
        <div class="ar-hud-top">
            <div class="slash-counter">
                SLASHES <span id="slash-count">0</span>
            </div>
            <div class="ar-btn-group">
                <button class="ar-icon-btn" id="btn-undo" title="Undo last">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/>
                    </svg>
                </button>
                <button class="ar-icon-btn" id="btn-clear" title="Clear all">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="ar-hud-bottom">
            <div class="ar-hint" id="ar-hint">TAP A SURFACE TO SLASH</div>
            <div class="ar-action-bar">
                <button class="ar-action-btn" id="btn-share" title="Share">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
                    </svg>
                </button>
                <button class="slash-btn" id="btn-slash" title="Slash!">
                    <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 62 L24 18 L28 62" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M36 62 L40 14 L44 62" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M52 62 L56 18 L60 62" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="ar-action-btn" id="btn-exit" title="Exit AR">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â• SHARE TRAY â•â•â• -->
    <div id="share-backdrop"></div>
    <div id="share-tray">
        <div class="share-header">
            <h3>SHARE SLASH</h3>
            <button class="share-close" id="share-close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <img class="share-preview" id="share-preview" alt="Screenshot preview">
        <div class="share-options">
            <div class="share-option" id="share-native-btn">
                <div class="share-option-icon share-native">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
                    </svg>
                </div>
                <span class="share-option-label">SHARE</span>
            </div>
            <div class="share-option" id="share-download-btn">
                <div class="share-option-icon share-download">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </div>
                <span class="share-option-label">SAVE</span>
            </div>
            <div class="share-option" id="share-copy-btn">
                <div class="share-option-icon share-copy">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                </div>
                <span class="share-option-label">COPY</span>
            </div>
        </div>
    </div>

    <!-- â•â•â• FLASH EFFECT â•â•â• -->
    <div class="slash-flash" id="slash-flash"></div>

    <!-- â•â•â• TOAST â•â•â• -->
    <div class="toast" id="toast"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         THREE.JS / WEBXR ENGINE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let renderer, scene, camera, controller;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let xrSession = null;

        let slashCount = 0;
        let activeSlashes = []; // Array of { group, meshes }
        const MAX_SLASHES = 30;

        // Hit test result cache
        let lastHitMatrix = null;
        let lastHitNormal = new THREE.Vector3(0, 1, 0);
        let reticleVisible = false;

        // DOM Elements
        const landing = document.getElementById('landing');
        const startBtn = document.getElementById('start-ar-btn');
        const overlay = document.getElementById('ar-overlay');
        const slashCountEl = document.getElementById('slash-count');
        const hintEl = document.getElementById('ar-hint');
        const flashEl = document.getElementById('slash-flash');
        const toast = document.getElementById('toast');
        const shareTray = document.getElementById('share-tray');
        const shareBackdrop = document.getElementById('share-backdrop');
        const sharePreview = document.getElementById('share-preview');

        // â”€â”€â”€ TEXTURE: Create procedural claw marks â”€â”€â”€â”€â”€â”€
        // We generate a proper claw slash texture procedurally
        // so the app works standalone without external assets.
        // If you have claws.png, it will be used instead.

        let clawTexture;
        const hasExternalTexture = true; // Set to true if deploying with claws.png

        function createProceduralClawTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // Clear transparent
            ctx.clearRect(0, 0, 512, 512);

            // Draw three claw slashes
            const slashes = [
                { x: 140, angle: -0.08 },
                { x: 256, angle: 0 },
                { x: 372, angle: 0.08 }
            ];

            slashes.forEach(slash => {
                ctx.save();
                ctx.translate(slash.x, 256);
                ctx.rotate(slash.angle);

                // Main slash body
                const grad = ctx.createLinearGradient(0, -220, 0, 220);
                grad.addColorStop(0, 'rgba(200,200,200,0)');
                grad.addColorStop(0.08, 'rgba(200,200,200,0.9)');
                grad.addColorStop(0.5, 'rgba(255,255,255,1)');
                grad.addColorStop(0.92, 'rgba(200,200,200,0.9)');
                grad.addColorStop(1, 'rgba(200,200,200,0)');

                ctx.beginPath();
                ctx.moveTo(-18, -220);
                ctx.quadraticCurveTo(-22, -80, -16, 0);
                ctx.quadraticCurveTo(-22, 80, -18, 220);
                ctx.lineTo(18, 220);
                ctx.quadraticCurveTo(22, 80, 16, 0);
                ctx.quadraticCurveTo(22, -80, 18, -220);
                ctx.closePath();
                ctx.fillStyle = grad;
                ctx.fill();

                // Inner bright core
                const innerGrad = ctx.createLinearGradient(0, -200, 0, 200);
                innerGrad.addColorStop(0, 'rgba(255,255,255,0)');
                innerGrad.addColorStop(0.1, 'rgba(255,255,255,0.6)');
                innerGrad.addColorStop(0.5, 'rgba(255,255,255,0.9)');
                innerGrad.addColorStop(0.9, 'rgba(255,255,255,0.6)');
                innerGrad.addColorStop(1, 'rgba(255,255,255,0)');

                ctx.beginPath();
                ctx.moveTo(-6, -200);
                ctx.quadraticCurveTo(-8, 0, -6, 200);
                ctx.lineTo(6, 200);
                ctx.quadraticCurveTo(8, 0, 6, -200);
                ctx.closePath();
                ctx.fillStyle = innerGrad;
                ctx.fill();

                ctx.restore();
            });

            const tex = new THREE.CanvasTexture(canvas);
            tex.needsUpdate = true;
            return tex;
        }

        // Try to load external texture, fall back to procedural
        const loader = new THREE.TextureLoader();
        clawTexture = createProceduralClawTexture(); // Start with procedural

        if (hasExternalTexture) {
            loader.load('claws.png',
                (tex) => { clawTexture = tex; console.log('External claw texture loaded'); },
                undefined,
                () => { console.log('No claws.png found, using procedural texture'); }
            );
        }

        // â”€â”€â”€ AUDIO: Procedural slice sound â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let audioCtx;
        let sliceSoundBuffer = null;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            createSliceSound();

            // Also try loading external sound
            fetch('slice.mp3')
                .then(r => { if (!r.ok) throw 'no file'; return r.arrayBuffer(); })
                .then(buf => audioCtx.decodeAudioData(buf))
                .then(decoded => { sliceSoundBuffer = decoded; console.log('External sound loaded'); })
                .catch(() => console.log('No slice.mp3, using synth sound'));
        }

        function createSliceSound() {
            // Synthesize a metallic slash sound
            const sr = audioCtx.sampleRate;
            const duration = 0.25;
            const buf = audioCtx.createBuffer(1, sr * duration, sr);
            const data = buf.getChannelData(0);

            for (let i = 0; i < data.length; i++) {
                const t = i / sr;
                const env = Math.exp(-t * 20) * 0.6;
                // Metallic noise burst
                const noise = (Math.random() * 2 - 1);
                // High frequency "shing"
                const shing = Math.sin(t * 4800 * Math.PI * 2) * 0.3 + Math.sin(t * 7200 * Math.PI * 2) * 0.15;
                data[i] = (noise * 0.4 + shing) * env;
            }
            sliceSoundBuffer = buf;
        }

        function playSliceSound() {
            if (!audioCtx || !sliceSoundBuffer) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const source = audioCtx.createBufferSource();
            source.buffer = sliceSoundBuffer;

            // High-pass filter for metallic quality
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 800;

            const gain = audioCtx.createGain();
            gain.gain.value = 0.5;

            source.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            source.start(0);
        }

        // â”€â”€â”€ RETICLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let reticle;

        function createReticle() {
            const group = new THREE.Group();

            // Outer ring
            const ringGeo = new THREE.RingGeometry(0.08, 0.09, 32);
            const ringMat = new THREE.MeshBasicMaterial({
                color: 0xffaa00,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide,
                depthTest: false
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);

            // Inner crosshair (three claw marks hint)
            const lineGeo = new THREE.BufferGeometry();
            const verts = new Float32Array([
                -0.02, 0, 0, -0.02, 0.05, 0,
                 0,    0, 0,  0,    0.06, 0,
                 0.02, 0, 0,  0.02, 0.05, 0
            ]);
            lineGeo.setAttribute('position', new THREE.BufferAttribute(verts, 3));
            const lineMat = new THREE.LineBasicMaterial({
                color: 0xffaa00,
                transparent: true,
                opacity: 0.8,
                depthTest: false
            });
            const lines = new THREE.LineSegments(lineGeo, lineMat);

            group.add(ring);
            group.add(lines);
            group.matrixAutoUpdate = false;
            group.visible = false;
            group.renderOrder = 999;

            return group;
        }

        // â”€â”€â”€ SPAWN SLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function spawnSlash(hitMatrix) {
            if (activeSlashes.length >= MAX_SLASHES) {
                removeOldestSlash();
            }

            const position = new THREE.Vector3();
            const quaternion = new THREE.Quaternion();
            const scale = new THREE.Vector3();
            hitMatrix.decompose(position, quaternion, scale);

            // Create a group for this slash
            const group = new THREE.Group();
            group.position.copy(position);
            group.quaternion.copy(quaternion);

            // Add slight random rotation around the surface normal for variety
            const randomRotZ = (Math.random() - 0.5) * 0.5; // Â±~15 degrees
            group.rotateZ(randomRotZ);

            // The claw mark plane â€” oriented to the detected surface
            const planeGeo = new THREE.PlaneGeometry(0.35, 0.45);
            const planeMat = new THREE.MeshBasicMaterial({
                map: clawTexture,
                transparent: true,
                opacity: 0,  // Will animate in
                side: THREE.DoubleSide,
                depthWrite: false,
                depthTest: true,
                blending: THREE.NormalBlending,
            });
            const plane = new THREE.Mesh(planeGeo, planeMat);

            // Slight offset from surface to prevent z-fighting
            plane.position.z = 0.002;
            plane.renderOrder = 10 + activeSlashes.length;

            group.add(plane);

            // Glow effect behind the slash
            const glowGeo = new THREE.PlaneGeometry(0.5, 0.6);
            const glowMat = new THREE.MeshBasicMaterial({
                color: 0xffaa00,
                transparent: true,
                opacity: 0,
                side: THREE.DoubleSide,
                depthWrite: false,
                depthTest: false,
                blending: THREE.AdditiveBlending,
            });
            const glow = new THREE.Mesh(glowGeo, glowMat);
            glow.position.z = 0.001;
            glow.renderOrder = 9 + activeSlashes.length;
            group.add(glow);

            scene.add(group);

            const slashData = {
                group,
                plane,
                glow,
                time: 0,
                animPhase: 'intro', // 'intro' | 'hold' | 'idle'
            };
            activeSlashes.push(slashData);

            // Update counter
            slashCount++;
            slashCountEl.textContent = slashCount;

            // Hide hint after first slash
            if (slashCount === 1) {
                hintEl.classList.add('hidden');
            }
        }

        // â”€â”€â”€ ANIMATION UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateSlashes(dt) {
            activeSlashes.forEach(slash => {
                slash.time += dt;

                if (slash.animPhase === 'intro') {
                    // Quick scale-in with overshoot
                    const t = Math.min(slash.time / 0.2, 1);
                    const ease = t < 1 ? 1 - Math.pow(1 - t, 3) : 1;
                    const scaleOvershoot = ease * (1 + (1 - t) * 0.15);

                    slash.plane.scale.set(scaleOvershoot, ease, 1);
                    slash.plane.material.opacity = Math.min(t * 3, 1);

                    // Glow flare
                    slash.glow.material.opacity = (1 - t) * 0.4;
                    slash.glow.scale.set(1 + t * 0.3, 1 + t * 0.3, 1);

                    if (t >= 1) {
                        slash.animPhase = 'idle';
                        slash.time = 0;
                    }
                } else if (slash.animPhase === 'idle') {
                    // Very subtle breathing
                    slash.plane.material.opacity = 0.95 + Math.sin(slash.time * 2) * 0.05;
                    slash.glow.material.opacity = 0.03 + Math.sin(slash.time * 1.5) * 0.02;
                }
            });
        }

        function removeOldestSlash() {
            if (activeSlashes.length === 0) return;
            const oldest = activeSlashes.shift();
            disposeSlash(oldest);
        }

        function removeLastSlash() {
            if (activeSlashes.length === 0) return;
            const last = activeSlashes.pop();
            disposeSlash(last);
            slashCount = Math.max(0, slashCount - 1);
            slashCountEl.textContent = slashCount;
        }

        function clearAllSlashes() {
            activeSlashes.forEach(s => disposeSlash(s));
            activeSlashes = [];
            slashCount = 0;
            slashCountEl.textContent = '0';
            hintEl.classList.remove('hidden');
        }

        function disposeSlash(slashData) {
            slashData.group.traverse(child => {
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (child.material.map && child.material.map !== clawTexture) {
                        child.material.map.dispose();
                    }
                    child.material.dispose();
                }
            });
            scene.remove(slashData.group);
        }

        // â”€â”€â”€ SCREEN EFFECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function triggerFlash() {
            flashEl.classList.remove('active');
            void flashEl.offsetWidth; // Reflow
            flashEl.classList.add('active');
        }

        function showToast(msg, duration = 2000) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // â”€â”€â”€ SHARE FUNCTIONALITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentScreenshotBlob = null;

        async function captureScreenshot() {
            if (!renderer) return null;

            // Force render one frame with preserveDrawingBuffer behavior
            // In WebXR we read pixels right after render
            const gl = renderer.getContext();
            const width = gl.drawingBufferWidth;
            const height = gl.drawingBufferHeight;

            const pixels = new Uint8Array(width * height * 4);
            gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

            // Flip vertically (WebGL reads bottom-up)
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const imgData = ctx.createImageData(width, height);

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const srcIdx = ((height - y - 1) * width + x) * 4;
                    const dstIdx = (y * width + x) * 4;
                    imgData.data[dstIdx]     = pixels[srcIdx];
                    imgData.data[dstIdx + 1] = pixels[srcIdx + 1];
                    imgData.data[dstIdx + 2] = pixels[srcIdx + 2];
                    imgData.data[dstIdx + 3] = pixels[srcIdx + 3];
                }
            }
            ctx.putImageData(imgData, 0, 0);

            // Add branding watermark
            ctx.fillStyle = 'rgba(255,170,0,0.7)';
            ctx.font = `bold ${Math.round(height * 0.02)}px "Bebas Neue", sans-serif`;
            ctx.letterSpacing = '3px';
            ctx.textAlign = 'right';
            ctx.fillText('SNIKT â€” Wolverine AR', width - 20, height - 20);

            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    currentScreenshotBlob = blob;
                    resolve(blob);
                }, 'image/png');
            });
        }

        function openShareTray() {
            captureScreenshot().then(blob => {
                if (blob) {
                    sharePreview.src = URL.createObjectURL(blob);
                    sharePreview.style.display = 'block';
                }
                shareTray.classList.add('open');
                shareBackdrop.classList.add('open');
            });
        }

        function closeShareTray() {
            shareTray.classList.remove('open');
            shareBackdrop.classList.remove('open');
        }

        async function shareNative() {
            if (!currentScreenshotBlob) {
                showToast('Capturingâ€¦');
                await captureScreenshot();
            }
            if (!navigator.share || !navigator.canShare) {
                showToast('Share not supported on this device');
                return;
            }
            const file = new File([currentScreenshotBlob], 'wolverine-ar-slash.png', { type: 'image/png' });
            try {
                await navigator.share({
                    title: 'SNIKT â€” Wolverine AR',
                    text: 'I just slashed surfaces in AR like Wolverine! ğŸº',
                    files: [file]
                });
                closeShareTray();
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('Share cancelled');
                }
            }
        }

        function downloadScreenshot() {
            if (!currentScreenshotBlob) return;
            const url = URL.createObjectURL(currentScreenshotBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wolverine-ar-${Date.now()}.png`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Saved to downloads');
            closeShareTray();
        }

        async function copyScreenshot() {
            if (!currentScreenshotBlob) return;
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': currentScreenshotBlob })
                ]);
                showToast('Copied to clipboard');
                closeShareTray();
            } catch {
                showToast('Copy not supported');
            }
        }

        // â”€â”€â”€ INIT THREE.JS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // Lighting
            const hemi = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.2);
            scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 1.5);
            dir.position.set(0.5, 1.5, 0.8);
            scene.add(dir);

            // Renderer â€” preserve drawing buffer for screenshots
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);

            // Reticle
            reticle = createReticle();
            scene.add(reticle);

            // Controller (handles tap)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // â”€â”€â”€ AR SESSION MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function startAR() {
            if (!navigator.xr) return;

            try {
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay', 'local-floor'],
                    domOverlay: { root: document.getElementById('ar-overlay') }
                });

                renderer.xr.setReferenceSpaceType('local');
                await renderer.xr.setSession(xrSession);

                // Show overlay
                overlay.classList.add('active');
                landing.classList.add('hidden');

                // Init audio on first user gesture
                if (!audioCtx) initAudio();

                // Session end handler
                xrSession.addEventListener('end', onSessionEnd);

                // Start render loop
                renderer.setAnimationLoop(render);

            } catch (err) {
                console.error('AR Session failed:', err);
                showToast('AR session failed â€” ' + err.message);
            }
        }

        function endAR() {
            if (xrSession) {
                xrSession.end();
            }
        }

        function onSessionEnd() {
            xrSession = null;
            hitTestSource = null;
            hitTestSourceRequested = false;
            overlay.classList.remove('active');
            landing.classList.remove('hidden');
            clearAllSlashes();
            renderer.setAnimationLoop(null);
        }

        // â”€â”€â”€ SELECT (TAP) HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function onSelect() {
            if (reticleVisible && lastHitMatrix) {
                playSliceSound();
                triggerFlash();
                spawnSlash(lastHitMatrix);
                if (navigator.vibrate) navigator.vibrate([30, 20, 30]);
            }
        }

        // â”€â”€â”€ RENDER LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let lastTimestamp = 0;

        function render(timestamp, frame) {
            const dt = lastTimestamp ? (timestamp - lastTimestamp) / 1000 : 0.016;
            lastTimestamp = timestamp;

            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                // Request hit test source
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(viewerSpace => {
                        session.requestHitTestSource({ space: viewerSpace }).then(source => {
                            hitTestSource = source;
                        }).catch(err => console.warn('Hit test source failed:', err));
                    });

                    session.addEventListener('end', () => {
                        hitTestSource = null;
                        hitTestSourceRequested = false;
                    });

                    hitTestSourceRequested = true;
                }

                // Process hit test results
                if (hitTestSource) {
                    const results = frame.getHitTestResults(hitTestSource);
                    if (results.length > 0) {
                        const hit = results[0];
                        const pose = hit.getPose(referenceSpace);
                        
                        if (pose) {
                            reticle.visible = true;
                            reticleVisible = true;

                            const matrix = new THREE.Matrix4();
                            matrix.fromArray(pose.transform.matrix);
                            reticle.matrix.copy(matrix);

                            // Cache for spawning
                            lastHitMatrix = matrix.clone();
                        }
                    } else {
                        reticle.visible = false;
                        reticleVisible = false;
                    }
                }
            }

            // Animate active slashes
            updateSlashes(dt);

            renderer.render(scene, camera);
        }

        // â”€â”€â”€ CHECK WEBXR SUPPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function checkSupport() {
            if (!navigator.xr) {
                startBtn.textContent = 'AR NOT SUPPORTED';
                document.getElementById('unsupported-area').innerHTML = `
                    <div class="unsupported-msg">
                        <p>WebXR is not available on this device or browser. 
                        You need Chrome on Android for AR experiences.</p>
                        <p class="error-detail">navigator.xr is undefined</p>
                    </div>`;
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    startBtn.textContent = 'ENTER AR';
                    startBtn.disabled = false;
                } else {
                    startBtn.textContent = 'AR NOT SUPPORTED';
                    document.getElementById('unsupported-area').innerHTML = `
                        <div class="unsupported-msg">
                            <p>This device doesn't support immersive AR sessions. 
                            Try Chrome on a recent Android phone.</p>
                        </div>`;
                }
            } catch (err) {
                startBtn.textContent = 'AR CHECK FAILED';
                document.getElementById('unsupported-area').innerHTML = `
                    <div class="unsupported-msg">
                        <p class="error-detail">${err.message}</p>
                    </div>`;
            }
        }

        // â”€â”€â”€ BUTTON EVENT LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        startBtn.addEventListener('click', startAR);

        // Slash button (alternative to tapping surface in AR)
        document.getElementById('btn-slash').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            onSelect();
        });

        document.getElementById('btn-undo').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            removeLastSlash();
            showToast('Undo');
        });

        document.getElementById('btn-clear').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            clearAllSlashes();
            showToast('Cleared');
        });

        document.getElementById('btn-share').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openShareTray();
        });

        document.getElementById('btn-exit').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            endAR();
        });

        // Share tray buttons
        document.getElementById('share-native-btn').addEventListener('click', shareNative);
        document.getElementById('share-download-btn').addEventListener('click', downloadScreenshot);
        document.getElementById('share-copy-btn').addEventListener('click', copyScreenshot);
        document.getElementById('share-close').addEventListener('click', closeShareTray);
        shareBackdrop.addEventListener('click', closeShareTray);

        // Prevent share tray from triggering XR events
        shareTray.addEventListener('beforexrselect', (e) => e.preventDefault());

        // â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        init();
        checkSupport();
    </script>
</body>
</html>
